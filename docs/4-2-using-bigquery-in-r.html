<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4.2 Using BigQuery in R | Global Fishing Watch Data Standard Operating Procedure</title>
  <meta name="description" content="Standard operating procedures for emLab projects using Global Fishing Watch data" />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="4.2 Using BigQuery in R | Global Fishing Watch Data Standard Operating Procedure" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://emlab-ucsb.github.io/gfw-SOP/" />
  
  <meta property="og:description" content="Standard operating procedures for emLab projects using Global Fishing Watch data" />
  <meta name="github-repo" content="emlab-ucsb/gfw-SOP" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4.2 Using BigQuery in R | Global Fishing Watch Data Standard Operating Procedure" />
  
  <meta name="twitter:description" content="Standard operating procedures for emLab projects using Global Fishing Watch data" />
  

<meta name="author" content="" />


<meta name="date" content="2021-01-22" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="favicon.png" type="image/x-icon" />
<link rel="prev" href="4-1-validation-with-bigquery.html"/>
<link rel="next" href="5-additional-resources.html"/>
<script src="assets/jquery-2.2.3/jquery.min.js"></script>
<link href="assets/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Overview</a></li>
<li class="chapter" data-level="1" data-path="1-global-fishing-watch-basics.html"><a href="1-global-fishing-watch-basics.html"><i class="fa fa-check"></i><b>1</b> Global Fishing Watch Basics</a><ul>
<li class="chapter" data-level="1.1" data-path="1-1-types-of-data.html"><a href="1-1-types-of-data.html"><i class="fa fa-check"></i><b>1.1</b> Types of Data</a></li>
<li class="chapter" data-level="1.2" data-path="1-2-available-data.html"><a href="1-2-available-data.html"><i class="fa fa-check"></i><b>1.2</b> Available Data</a></li>
<li class="chapter" data-level="1.3" data-path="1-3-data-caution.html"><a href="1-3-data-caution.html"><i class="fa fa-check"></i><b>1.3</b> Data Caution</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="2-setup-and-access.html"><a href="2-setup-and-access.html"><i class="fa fa-check"></i><b>2</b> Setup and Access</a><ul>
<li class="chapter" data-level="2.1" data-path="2-1-bigquery-setup.html"><a href="2-1-bigquery-setup.html"><i class="fa fa-check"></i><b>2.1</b> BigQuery Setup</a></li>
<li class="chapter" data-level="2.2" data-path="2-2-billing.html"><a href="2-2-billing.html"><i class="fa fa-check"></i><b>2.2</b> Billing</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="3-data.html"><a href="3-data.html"><i class="fa fa-check"></i><b>3</b> Data</a><ul>
<li class="chapter" data-level="3.1" data-path="3-1-core-ais-datasets-and-assumptions.html"><a href="3-1-core-ais-datasets-and-assumptions.html"><i class="fa fa-check"></i><b>3.1</b> Core AIS Datasets and Assumptions</a></li>
<li class="chapter" data-level="3.2" data-path="3-2-best-tables.html"><a href="3-2-best-tables.html"><i class="fa fa-check"></i><b>3.2</b> Best Tables</a></li>
<li class="chapter" data-level="3.3" data-path="3-3-vms-datasets.html"><a href="3-3-vms-datasets.html"><i class="fa fa-check"></i><b>3.3</b> VMS Datasets</a></li>
<li class="chapter" data-level="3.4" data-path="3-4-dark-targets-tables.html"><a href="3-4-dark-targets-tables.html"><i class="fa fa-check"></i><b>3.4</b> Dark Targets Tables</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="4-workflow.html"><a href="4-workflow.html"><i class="fa fa-check"></i><b>4</b> Workflow</a><ul>
<li class="chapter" data-level="4.1" data-path="4-1-validation-with-bigquery.html"><a href="4-1-validation-with-bigquery.html"><i class="fa fa-check"></i><b>4.1</b> Validation with BigQuery</a></li>
<li class="chapter" data-level="4.2" data-path="4-2-using-bigquery-in-r.html"><a href="4-2-using-bigquery-in-r.html"><i class="fa fa-check"></i><b>4.2</b> Using BigQuery in R</a><ul>
<li class="chapter" data-level="4.2.1" data-path="4-2-using-bigquery-in-r.html"><a href="4-2-using-bigquery-in-r.html#authorization"><i class="fa fa-check"></i><b>4.2.1</b> Authorization</a></li>
<li class="chapter" data-level="4.2.2" data-path="4-2-using-bigquery-in-r.html"><a href="4-2-using-bigquery-in-r.html#accessing-data"><i class="fa fa-check"></i><b>4.2.2</b> Accessing Data</a></li>
<li class="chapter" data-level="4.2.3" data-path="4-2-using-bigquery-in-r.html"><a href="4-2-using-bigquery-in-r.html#writing-and-executing-queries"><i class="fa fa-check"></i><b>4.2.3</b> Writing and Executing Queries</a></li>
<li class="chapter" data-level="4.2.4" data-path="4-2-using-bigquery-in-r.html"><a href="4-2-using-bigquery-in-r.html#subsetting-data"><i class="fa fa-check"></i><b>4.2.4</b> Subsetting Data</a></li>
<li class="chapter" data-level="4.2.5" data-path="4-2-using-bigquery-in-r.html"><a href="4-2-using-bigquery-in-r.html#saving-downloading-bigquery-tables"><i class="fa fa-check"></i><b>4.2.5</b> Saving / Downloading BigQuery Tables</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="5-additional-resources.html"><a href="5-additional-resources.html"><i class="fa fa-check"></i><b>5</b> Additional Resources</a><ul>
<li class="chapter" data-level="5.1" data-path="5-1-global-fishing-watch-data-training.html"><a href="5-1-global-fishing-watch-data-training.html"><i class="fa fa-check"></i><b>5.1</b> Global Fishing Watch Data Training</a></li>
<li class="chapter" data-level="5.2" data-path="5-2-fishwatchr.html"><a href="5-2-fishwatchr.html"><i class="fa fa-check"></i><b>5.2</b> Fishwatchr</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Global Fishing Watch Data Standard Operating Procedure</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="using-bigquery-in-r" class="section level2">
<h2><span class="header-section-number">4.2</span> Using BigQuery in R</h2>
<p>There is no single best way to access and use GFW data in R. Below are a few techniques that can be used depending on personal preference and project needs. While it is possible to use GFW data without writing SQL using the <code>dbplyr</code> package, this document focuses on workflow to integrate SQL into R.</p>
<p>BigQuery can understand both Standard and Legacy SQL. Best practice to use <em>Standard SQL</em>. BigQuery has a very helpful <a href="https://cloud.google.com/bigquery/docs/reference">Reference Guide</a> for functions and operators in Standard SQL. In particular, the ‘Functions and Operators’ section, found under the ‘Standard SQL query reference’ heading, contains helpful documentation on a range of functions categorized by type.</p>
<p><img src="images/standard_sql_ref_annotated.png" style="width:50.0%;height:50.0%" /></p>
<div id="authorization" class="section level3">
<h3><span class="header-section-number">4.2.1</span> Authorization</h3>
<p>BigQuery requires authorization to execute functions in R. Running the <code>bq_auth()</code> function from the <code>bigrquery</code> package in the console will open a new tab in your web browser allowing you to authenticate your credentials. BigQuery will cache your credentials for use in the future, but it is still necessary to run <code>bq_auth()</code> each time you start a new Rproject. If you forget to authenticate your credentials before trying to execute a query, BigQuery will produce an error message.</p>
</div>
<div id="accessing-data" class="section level3">
<h3><span class="header-section-number">4.2.2</span> Accessing Data</h3>
<p>When writing SQL data can be accessed using three pieces of information: the project, the dataset, and the table. This should follow the syntax project.dataset.table. Specifying the project first is important. SQL will only be able to find datasets and tables within the billing project (e.g. <code>emlab-gcp</code>) if no project is specified. For example when <code>emlab-gcp</code> is set as the billing project, trying to access the <code>eez_info</code> table using <code>gfw_research.eez_info</code> produces an error that the table does not exist. Adding the project first, <code>world-fishing-827.gfw_research.eez_info</code> fixes the query.</p>
<p><img src="images/table_error_annotated.png" style="width:50.0%;height:50.0%" /></p>
<p>Best practice is to always specify the project since this reduces potential errors if others replicate your code using a different billing project.</p>
</div>
<div id="writing-and-executing-queries" class="section level3">
<h3><span class="header-section-number">4.2.3</span> Writing and Executing Queries</h3>
<p>There are two main methods for executing SQL in R. One is to write the SQL query as a string and then execute it using the bigrquery or DBI packages. The second is to use an SQL chunk within your markdown or notebook. The following libraries are useful for accessing GFW data: <code>DBI</code>, <code>bigrquery</code>, <code>glue</code>.</p>
<p><em>Writing Queries as Strings</em></p>
<p>Queries can be written as strings in R. Best practice is to avoid looped or nested queries and instead use subqueries. Subqueries can be written using ‘WITH’ statements.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co">#############################################################</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="co"># Example Query: Find which EEZs vessels fished in </span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="co"># Description:</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="co"># This query uses the vessel info table to identify all vessels</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="co"># that fished in China each year and how much they fished.</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="co">#############################################################</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1-8" data-line-number="8">sql_vessels_in_china &lt;-<span class="st"> &quot;#StandardSQL</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="st">WITH</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="st">  ###############################</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="st">  # Get EEZ ID and info  </span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="st">  </span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15"><span class="st">  eez_names AS (</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="st">  SELECT</span></a>
<a class="sourceLine" id="cb1-17" data-line-number="17"><span class="st">    CAST(eez_id AS STRING) AS eez,</span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18"><span class="st">    reporting_name,</span></a>
<a class="sourceLine" id="cb1-19" data-line-number="19"><span class="st">    sovereign1_iso3 AS eez_iso3</span></a>
<a class="sourceLine" id="cb1-20" data-line-number="20"><span class="st">  FROM</span></a>
<a class="sourceLine" id="cb1-21" data-line-number="21"><span class="st">    `world-fishing-827.gfw_research.eez_info`),</span></a>
<a class="sourceLine" id="cb1-22" data-line-number="22"></a>
<a class="sourceLine" id="cb1-23" data-line-number="23"><span class="st">  ###############################</span></a>
<a class="sourceLine" id="cb1-24" data-line-number="24"><span class="st">  # Get EEZ fishing summary from activity.eez array </span></a>
<a class="sourceLine" id="cb1-25" data-line-number="25"><span class="st">  </span></a>
<a class="sourceLine" id="cb1-26" data-line-number="26"><span class="st">  eez_fishing AS (</span></a>
<a class="sourceLine" id="cb1-27" data-line-number="27"><span class="st">  SELECT</span></a>
<a class="sourceLine" id="cb1-28" data-line-number="28"><span class="st">    ssvid,</span></a>
<a class="sourceLine" id="cb1-29" data-line-number="29"><span class="st">    year,</span></a>
<a class="sourceLine" id="cb1-30" data-line-number="30"><span class="st">    best.best_flag,</span></a>
<a class="sourceLine" id="cb1-31" data-line-number="31"><span class="st">    best.best_vessel_class,</span></a>
<a class="sourceLine" id="cb1-32" data-line-number="32"><span class="st">    value AS eez,</span></a>
<a class="sourceLine" id="cb1-33" data-line-number="33"><span class="st">    fishing_hours</span></a>
<a class="sourceLine" id="cb1-34" data-line-number="34"><span class="st">  FROM</span></a>
<a class="sourceLine" id="cb1-35" data-line-number="35"><span class="st">    `world-fishing-827.gfw_research.vi_ssvid_byyear_v20201209`</span></a>
<a class="sourceLine" id="cb1-36" data-line-number="36"><span class="st">  CROSS JOIN</span></a>
<a class="sourceLine" id="cb1-37" data-line-number="37"><span class="st">    UNNEST(activity.eez)</span></a>
<a class="sourceLine" id="cb1-38" data-line-number="38"><span class="st">  WHERE on_fishing_list_best),</span></a>
<a class="sourceLine" id="cb1-39" data-line-number="39"></a>
<a class="sourceLine" id="cb1-40" data-line-number="40"><span class="st">  ###############################</span></a>
<a class="sourceLine" id="cb1-41" data-line-number="41"><span class="st">  # Join country name to EEZ id</span></a>
<a class="sourceLine" id="cb1-42" data-line-number="42"><span class="st">  </span></a>
<a class="sourceLine" id="cb1-43" data-line-number="43"><span class="st">  eez_fishing_labeled AS (</span></a>
<a class="sourceLine" id="cb1-44" data-line-number="44"><span class="st">  SELECT</span></a>
<a class="sourceLine" id="cb1-45" data-line-number="45"><span class="st">    *</span></a>
<a class="sourceLine" id="cb1-46" data-line-number="46"><span class="st">  FROM</span></a>
<a class="sourceLine" id="cb1-47" data-line-number="47"><span class="st">    eez_fishing</span></a>
<a class="sourceLine" id="cb1-48" data-line-number="48"><span class="st">  JOIN</span></a>
<a class="sourceLine" id="cb1-49" data-line-number="49"><span class="st">    eez_names</span></a>
<a class="sourceLine" id="cb1-50" data-line-number="50"><span class="st">  USING</span></a>
<a class="sourceLine" id="cb1-51" data-line-number="51"><span class="st">    (eez)),</span></a>
<a class="sourceLine" id="cb1-52" data-line-number="52"></a>
<a class="sourceLine" id="cb1-53" data-line-number="53"><span class="st">  ###############################</span></a>
<a class="sourceLine" id="cb1-54" data-line-number="54"><span class="st">  # Filter to fishing in China using ISO3</span></a>
<a class="sourceLine" id="cb1-55" data-line-number="55"></a>
<a class="sourceLine" id="cb1-56" data-line-number="56"><span class="st">  chn_fishing AS (</span></a>
<a class="sourceLine" id="cb1-57" data-line-number="57"><span class="st">  SELECT</span></a>
<a class="sourceLine" id="cb1-58" data-line-number="58"><span class="st">    * </span></a>
<a class="sourceLine" id="cb1-59" data-line-number="59"><span class="st">  FROM</span></a>
<a class="sourceLine" id="cb1-60" data-line-number="60"><span class="st">    eez_fishing_labeled </span></a>
<a class="sourceLine" id="cb1-61" data-line-number="61"><span class="st">  WHERE</span></a>
<a class="sourceLine" id="cb1-62" data-line-number="62"><span class="st">    eez_iso3 = &#39;CHN&#39;</span></a>
<a class="sourceLine" id="cb1-63" data-line-number="63"><span class="st">    AND fishing_hours &gt; 0)</span></a>
<a class="sourceLine" id="cb1-64" data-line-number="64"></a>
<a class="sourceLine" id="cb1-65" data-line-number="65"><span class="st">  ###############################</span></a>
<a class="sourceLine" id="cb1-66" data-line-number="66"><span class="st">  </span></a>
<a class="sourceLine" id="cb1-67" data-line-number="67"><span class="st">  SELECT * FROM chn_fishing&quot;</span></a></code></pre></div>
<p>The query can be run using the <code>bigrquery</code> package or the <code>DBI</code> package. When using <code>bigrquery</code>, the <code>bq_project_query()</code> function enables you to run the query and only requires the billing code and the query string. This function will not download the results of your query. To run the query and download results locally you can combine the <code>bq_project_query()</code> and <code>bq_table_download()</code> functions. More information is available in the package <a href="https://cran.r-project.org/web/packages/bigrquery/bigrquery.pdf">documentation</a>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># Run query only - stores results to a temporary table in BigQuery</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">bq_project_query</span>(<span class="st">&quot;emlab-gcp&quot;</span>, sql_vessels_in_china)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="co"># Run query and download results</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">vessels_in_china &lt;-<span class="st"> </span><span class="kw">bq_project_query</span>(<span class="st">&quot;emlab-gcp&quot;</span>, sql_vessels_in_china) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="st">  </span><span class="kw">bq_table_download</span>(<span class="dt">max_results =</span> <span class="ot">Inf</span>)</a></code></pre></div>
<p>A second option is to connect to BigQuery using the <code>DBI</code> package. When using DBI you first setup the connection using <code>dbConnect()</code> and then you can run your query using <code>dbGetQuery()</code>. The connection requires the driver (BigQuery), project name, and billing code. More information about <code>DBI</code> is available in the package <a href="https://cran.r-project.org/web/packages/DBI/DBI.pdf">documentation</a>.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># Set up connection</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">bq_connection &lt;-<span class="st"> </span><span class="kw">dbConnect</span>(</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">    <span class="kw">bigquery</span>(),</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">    <span class="dt">project =</span> <span class="st">&quot;world-fishing-827&quot;</span>,</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">    <span class="dt">billing =</span> <span class="st">&quot;emlab-gcp&quot;</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">)</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="co"># Run query </span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9">vessels_in_china &lt;-<span class="st"> </span><span class="kw">dbGetQuery</span>(bq_connection, sql_vessels_in_china)</a></code></pre></div>
<p><em>Writing Queries Using glue</em></p>
<p>Using <code>glue::glue_sql()</code> allows for substitution of R variables into the query. Substitute R variables into the query using <code>{variable}</code>. Be aware of proper syntax: substituting characters requires using back ticks but numbers or integers don’t. This might be useful if, for example, you want to run the same query for different years. Using <code>glue_sql()</code> requires adding the connection using the <code>.con</code> arguument after the query string. The connection is established in the same way as above, using <code>dbConnect()</code>. The query can then be run using either <code>DBI</code> or <code>bigrquery</code> as shown above.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co">#############################################################</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co"># Example Query: Find which EEZs vessels fished in annually </span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co"># Description:</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co"># This query uses the vessel info table to identify all vessels</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co"># that fished in China in 2019 and how much they fished.</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co">#############################################################</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="co"># Define variables</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10">country &lt;-<span class="st"> &#39;CHN&#39;</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11">year    &lt;-<span class="st"> </span><span class="dv">2019</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"></a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="co"># Write query</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"></a>
<a class="sourceLine" id="cb4-15" data-line-number="15">sql_vessels_in_china &lt;-<span class="st"> </span><span class="kw">glue_sql</span>(<span class="st">&quot;#StandardSQL</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16"></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="st">WITH</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18"></a>
<a class="sourceLine" id="cb4-19" data-line-number="19"><span class="st">  ###############################</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20"><span class="st">  # Get EEZ ID and info  </span></a>
<a class="sourceLine" id="cb4-21" data-line-number="21"><span class="st">  </span></a>
<a class="sourceLine" id="cb4-22" data-line-number="22"><span class="st">  eez_names AS (</span></a>
<a class="sourceLine" id="cb4-23" data-line-number="23"><span class="st">  SELECT</span></a>
<a class="sourceLine" id="cb4-24" data-line-number="24"><span class="st">    CAST(eez_id AS STRING) AS eez,</span></a>
<a class="sourceLine" id="cb4-25" data-line-number="25"><span class="st">    reporting_name,</span></a>
<a class="sourceLine" id="cb4-26" data-line-number="26"><span class="st">    sovereign1_iso3 AS eez_iso3</span></a>
<a class="sourceLine" id="cb4-27" data-line-number="27"><span class="st">  FROM</span></a>
<a class="sourceLine" id="cb4-28" data-line-number="28"><span class="st">    `world-fishing-827.gfw_research.eez_info`),</span></a>
<a class="sourceLine" id="cb4-29" data-line-number="29"></a>
<a class="sourceLine" id="cb4-30" data-line-number="30"><span class="st">  ###############################</span></a>
<a class="sourceLine" id="cb4-31" data-line-number="31"><span class="st">  # Get EEZ fishing summary from activity.eez array </span></a>
<a class="sourceLine" id="cb4-32" data-line-number="32"><span class="st">  </span></a>
<a class="sourceLine" id="cb4-33" data-line-number="33"><span class="st">  eez_fishing AS (</span></a>
<a class="sourceLine" id="cb4-34" data-line-number="34"><span class="st">  SELECT</span></a>
<a class="sourceLine" id="cb4-35" data-line-number="35"><span class="st">    ssvid,</span></a>
<a class="sourceLine" id="cb4-36" data-line-number="36"><span class="st">    year,</span></a>
<a class="sourceLine" id="cb4-37" data-line-number="37"><span class="st">    best.best_flag,</span></a>
<a class="sourceLine" id="cb4-38" data-line-number="38"><span class="st">    best.best_vessel_class,</span></a>
<a class="sourceLine" id="cb4-39" data-line-number="39"><span class="st">    value AS eez,</span></a>
<a class="sourceLine" id="cb4-40" data-line-number="40"><span class="st">    fishing_hours</span></a>
<a class="sourceLine" id="cb4-41" data-line-number="41"><span class="st">  FROM</span></a>
<a class="sourceLine" id="cb4-42" data-line-number="42"><span class="st">    `world-fishing-827.gfw_research.vi_ssvid_byyear_v20201209`</span></a>
<a class="sourceLine" id="cb4-43" data-line-number="43"><span class="st">  CROSS JOIN</span></a>
<a class="sourceLine" id="cb4-44" data-line-number="44"><span class="st">    UNNEST(activity.eez)</span></a>
<a class="sourceLine" id="cb4-45" data-line-number="45"><span class="st">  WHERE on_fishing_list_best</span></a>
<a class="sourceLine" id="cb4-46" data-line-number="46"><span class="st">  AND year = {year}),</span></a>
<a class="sourceLine" id="cb4-47" data-line-number="47"></a>
<a class="sourceLine" id="cb4-48" data-line-number="48"><span class="st">  ###############################</span></a>
<a class="sourceLine" id="cb4-49" data-line-number="49"><span class="st">  # Join country name to EEZ id</span></a>
<a class="sourceLine" id="cb4-50" data-line-number="50"><span class="st">  </span></a>
<a class="sourceLine" id="cb4-51" data-line-number="51"><span class="st">  eez_fishing_labeled AS (</span></a>
<a class="sourceLine" id="cb4-52" data-line-number="52"><span class="st">  SELECT</span></a>
<a class="sourceLine" id="cb4-53" data-line-number="53"><span class="st">    *</span></a>
<a class="sourceLine" id="cb4-54" data-line-number="54"><span class="st">  FROM</span></a>
<a class="sourceLine" id="cb4-55" data-line-number="55"><span class="st">    eez_fishing</span></a>
<a class="sourceLine" id="cb4-56" data-line-number="56"><span class="st">  JOIN</span></a>
<a class="sourceLine" id="cb4-57" data-line-number="57"><span class="st">    eez_names</span></a>
<a class="sourceLine" id="cb4-58" data-line-number="58"><span class="st">  USING</span></a>
<a class="sourceLine" id="cb4-59" data-line-number="59"><span class="st">    (eez)),</span></a>
<a class="sourceLine" id="cb4-60" data-line-number="60"></a>
<a class="sourceLine" id="cb4-61" data-line-number="61"><span class="st">  ###############################</span></a>
<a class="sourceLine" id="cb4-62" data-line-number="62"><span class="st">  # Filter to fishing in China using ISO3</span></a>
<a class="sourceLine" id="cb4-63" data-line-number="63"></a>
<a class="sourceLine" id="cb4-64" data-line-number="64"><span class="st">  chn_fishing AS (</span></a>
<a class="sourceLine" id="cb4-65" data-line-number="65"><span class="st">  SELECT</span></a>
<a class="sourceLine" id="cb4-66" data-line-number="66"><span class="st">    * </span></a>
<a class="sourceLine" id="cb4-67" data-line-number="67"><span class="st">  FROM</span></a>
<a class="sourceLine" id="cb4-68" data-line-number="68"><span class="st">    eez_fishing_labeled </span></a>
<a class="sourceLine" id="cb4-69" data-line-number="69"><span class="st">  WHERE</span></a>
<a class="sourceLine" id="cb4-70" data-line-number="70"><span class="st">    eez_iso3 = {`country`}</span></a>
<a class="sourceLine" id="cb4-71" data-line-number="71"><span class="st">    AND fishing_hours &gt; 0)</span></a>
<a class="sourceLine" id="cb4-72" data-line-number="72"></a>
<a class="sourceLine" id="cb4-73" data-line-number="73"><span class="st">  ###############################</span></a>
<a class="sourceLine" id="cb4-74" data-line-number="74"><span class="st">  </span></a>
<a class="sourceLine" id="cb4-75" data-line-number="75"><span class="st">  SELECT * FROM chn_fishing&quot;</span>, <span class="dt">.con =</span> bq_connection)</a>
<a class="sourceLine" id="cb4-76" data-line-number="76"></a>
<a class="sourceLine" id="cb4-77" data-line-number="77"><span class="co"># Run query </span></a>
<a class="sourceLine" id="cb4-78" data-line-number="78">vessels_in_china_<span class="dv">2019</span> &lt;-<span class="st"> </span><span class="kw">bq_project_query</span>(<span class="st">&quot;emlab-gcp&quot;</span>, sql_vessels_in_china) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-79" data-line-number="79"><span class="st">  </span><span class="kw">bq_table_download</span>(<span class="dt">max_results =</span> <span class="ot">Inf</span>)</a></code></pre></div>
<p><em>Using SQL Chunks</em></p>
<p>Both R markdown and R notebooks allow for integration of prose and different programming languages, such as python or SQL, within one document. Selecting “Insert → SQL” will add a code chunk to the document and enable you to write in SQL directly instead of saving the query as a string. In SQL chunks instead of using # to annotate, comments should be enclosed by <code>/* */</code> (i.e. <code>/* Comment */</code>).</p>
<p>When using SQL code chunks, it is important to specify the database connection and the output variable within the top of the code chunk. The database connection is established in the same way as shown above with <code>DBI::dbConnect()</code>. After running the code chunk, the results should appear in the enviroment using the name of the output variable.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">WITH</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">  <span class="co">/* Get EEZ id and info */</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  eez_names <span class="kw">AS</span> (</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  <span class="kw">SELECT</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">    <span class="fu">CAST</span>(eez_id <span class="kw">AS</span> STRING) <span class="kw">AS</span> eez,</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">    reporting_name,</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">    sovereign1_iso3 <span class="kw">AS</span> eez_iso3</a>
<a class="sourceLine" id="cb5-10" data-line-number="10">  <span class="kw">FROM</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11">    `world-fishing<span class="fl">-827.</span>gfw_research.eez_info`),</a>
<a class="sourceLine" id="cb5-12" data-line-number="12"></a>
<a class="sourceLine" id="cb5-13" data-line-number="13">  <span class="co">/* Get EEZ fishing summary from activity.eez array */</span></a>
<a class="sourceLine" id="cb5-14" data-line-number="14">  </a>
<a class="sourceLine" id="cb5-15" data-line-number="15">  eez_fishing <span class="kw">AS</span> (</a>
<a class="sourceLine" id="cb5-16" data-line-number="16">  <span class="kw">SELECT</span></a>
<a class="sourceLine" id="cb5-17" data-line-number="17">    ssvid,</a>
<a class="sourceLine" id="cb5-18" data-line-number="18">    <span class="dt">year</span>,</a>
<a class="sourceLine" id="cb5-19" data-line-number="19">    best.best_flag,</a>
<a class="sourceLine" id="cb5-20" data-line-number="20">    best.best_vessel_class,</a>
<a class="sourceLine" id="cb5-21" data-line-number="21">    <span class="fu">value</span> <span class="kw">AS</span> eez,</a>
<a class="sourceLine" id="cb5-22" data-line-number="22">    fishing_hours</a>
<a class="sourceLine" id="cb5-23" data-line-number="23">  <span class="kw">FROM</span></a>
<a class="sourceLine" id="cb5-24" data-line-number="24">    `world-fishing<span class="fl">-827.</span>gfw_research.vi_ssvid_byyear_v20201209`</a>
<a class="sourceLine" id="cb5-25" data-line-number="25">  <span class="kw">CROSS</span> <span class="kw">JOIN</span></a>
<a class="sourceLine" id="cb5-26" data-line-number="26">    UNNEST(activity.eez)</a>
<a class="sourceLine" id="cb5-27" data-line-number="27">  <span class="kw">WHERE</span> on_fishing_list_best),</a>
<a class="sourceLine" id="cb5-28" data-line-number="28"></a>
<a class="sourceLine" id="cb5-29" data-line-number="29">  <span class="co">/* Join country name to EEZ id */</span></a>
<a class="sourceLine" id="cb5-30" data-line-number="30">  </a>
<a class="sourceLine" id="cb5-31" data-line-number="31">  eez_fishing_labeled <span class="kw">AS</span> (</a>
<a class="sourceLine" id="cb5-32" data-line-number="32">  <span class="kw">SELECT</span></a>
<a class="sourceLine" id="cb5-33" data-line-number="33">    *</a>
<a class="sourceLine" id="cb5-34" data-line-number="34">  <span class="kw">FROM</span></a>
<a class="sourceLine" id="cb5-35" data-line-number="35">    eez_fishing</a>
<a class="sourceLine" id="cb5-36" data-line-number="36">  <span class="kw">JOIN</span></a>
<a class="sourceLine" id="cb5-37" data-line-number="37">    eez_names</a>
<a class="sourceLine" id="cb5-38" data-line-number="38">  <span class="kw">USING</span></a>
<a class="sourceLine" id="cb5-39" data-line-number="39">    (eez)),</a>
<a class="sourceLine" id="cb5-40" data-line-number="40"></a>
<a class="sourceLine" id="cb5-41" data-line-number="41">  <span class="co">/* Filter to fishing in China using ISO3 */</span></a>
<a class="sourceLine" id="cb5-42" data-line-number="42"></a>
<a class="sourceLine" id="cb5-43" data-line-number="43">  chn_fishing <span class="kw">AS</span> (</a>
<a class="sourceLine" id="cb5-44" data-line-number="44">  <span class="kw">SELECT</span></a>
<a class="sourceLine" id="cb5-45" data-line-number="45">    * </a>
<a class="sourceLine" id="cb5-46" data-line-number="46">  <span class="kw">FROM</span></a>
<a class="sourceLine" id="cb5-47" data-line-number="47">    eez_fishing_labeled </a>
<a class="sourceLine" id="cb5-48" data-line-number="48">  <span class="kw">WHERE</span></a>
<a class="sourceLine" id="cb5-49" data-line-number="49">    eez_iso3 = <span class="st">&#39;CHN&#39;</span></a>
<a class="sourceLine" id="cb5-50" data-line-number="50">    <span class="kw">AND</span> fishing_hours &gt; <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb5-51" data-line-number="51"></a>
<a class="sourceLine" id="cb5-52" data-line-number="52">  <span class="co">/* Select the final query */</span> </a>
<a class="sourceLine" id="cb5-53" data-line-number="53">  </a>
<a class="sourceLine" id="cb5-54" data-line-number="54">  <span class="kw">SELECT</span> * <span class="kw">FROM</span> chn_fishing</a></code></pre></div>
</div>
<div id="subsetting-data" class="section level3">
<h3><span class="header-section-number">4.2.4</span> Subsetting Data</h3>
<p>Some queries may be expensive to run and output large amounts of data. To check results from queries or to make sure they work correctly, it may be necessary to subset the data. Tables that are partitioned are divided up into smaller segments and can be easily subsetted to reduce query size and cost. A common technique for subsetting data is to restrict the date range to a single day. This can be accomplished using WHERE plus a date filter (like _PARTIONTIME) although the specific notation will depend on if the data are represented as a date or a timestamp. Partitioned tables are noted in Section 3 and more information on partitioned tables can be found in the BigQuery <a href="https://cloud.google.com/bigquery/docs/partitioned-tables?_ga=2.76664789.-1147900105.1599252261">documentation</a>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co">#############################################################</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co"># Example Query: Fishing hours for January 1, 2019 </span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="co"># Description:</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co"># This query uses the fishing table to calculate fishing</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="co"># hours January 1, 2019.</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="co">#############################################################</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"></a>
<a class="sourceLine" id="cb6-8" data-line-number="8">sql_fishing_hours &lt;-<span class="st"> &quot;#StandardSQL</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"></a>
<a class="sourceLine" id="cb6-10" data-line-number="10"><span class="st">WITH</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11"></a>
<a class="sourceLine" id="cb6-12" data-line-number="12"><span class="st">  ###############################</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13"><span class="st">  # Find good segments</span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14"><span class="st">  </span></a>
<a class="sourceLine" id="cb6-15" data-line-number="15"><span class="st">  good_segments AS (</span></a>
<a class="sourceLine" id="cb6-16" data-line-number="16"><span class="st">  SELECT</span></a>
<a class="sourceLine" id="cb6-17" data-line-number="17"><span class="st">    seg_id</span></a>
<a class="sourceLine" id="cb6-18" data-line-number="18"><span class="st">  FROM</span></a>
<a class="sourceLine" id="cb6-19" data-line-number="19"><span class="st">    world-fishing-827.gfw_research.pipe_v20201001_segs</span></a>
<a class="sourceLine" id="cb6-20" data-line-number="20"><span class="st">  WHERE</span></a>
<a class="sourceLine" id="cb6-21" data-line-number="21"><span class="st">    good_seg</span></a>
<a class="sourceLine" id="cb6-22" data-line-number="22"><span class="st">    AND positions &gt; 10</span></a>
<a class="sourceLine" id="cb6-23" data-line-number="23"><span class="st">    AND NOT overlapping_and_short),</span></a>
<a class="sourceLine" id="cb6-24" data-line-number="24"><span class="st">  </span></a>
<a class="sourceLine" id="cb6-25" data-line-number="25"><span class="st">  #######################</span></a>
<a class="sourceLine" id="cb6-26" data-line-number="26"><span class="st">  # Active non-noise fishing vessels</span></a>
<a class="sourceLine" id="cb6-27" data-line-number="27"><span class="st">  </span></a>
<a class="sourceLine" id="cb6-28" data-line-number="28"><span class="st">  fishing_vessels AS (</span></a>
<a class="sourceLine" id="cb6-29" data-line-number="29"><span class="st">  SELECT</span></a>
<a class="sourceLine" id="cb6-30" data-line-number="30"><span class="st">    *</span></a>
<a class="sourceLine" id="cb6-31" data-line-number="31"><span class="st">  FROM </span></a>
<a class="sourceLine" id="cb6-32" data-line-number="32"><span class="st">    world-fishing-827.gfw_research.fishing_vessels_ssvid_v20201209 </span></a>
<a class="sourceLine" id="cb6-33" data-line-number="33"><span class="st">  WHERE </span></a>
<a class="sourceLine" id="cb6-34" data-line-number="34"><span class="st">    year = 2019),</span></a>
<a class="sourceLine" id="cb6-35" data-line-number="35"><span class="st">    </span></a>
<a class="sourceLine" id="cb6-36" data-line-number="36"><span class="st">  ###############################</span></a>
<a class="sourceLine" id="cb6-37" data-line-number="37"><span class="st">  # Find fishing hours </span></a>
<a class="sourceLine" id="cb6-38" data-line-number="38"><span class="st">  </span></a>
<a class="sourceLine" id="cb6-39" data-line-number="39"><span class="st">  fishing_hours AS ( </span></a>
<a class="sourceLine" id="cb6-40" data-line-number="40"><span class="st">  SELECT</span></a>
<a class="sourceLine" id="cb6-41" data-line-number="41"><span class="st">    ssvid, </span></a>
<a class="sourceLine" id="cb6-42" data-line-number="42"><span class="st">    timestamp,</span></a>
<a class="sourceLine" id="cb6-43" data-line-number="43"><span class="st">    lat,</span></a>
<a class="sourceLine" id="cb6-44" data-line-number="44"><span class="st">    lon,</span></a>
<a class="sourceLine" id="cb6-45" data-line-number="45"><span class="st">    hours,</span></a>
<a class="sourceLine" id="cb6-46" data-line-number="46"><span class="st">    IF(nnet_score &gt; 1, hours, 0) AS fishing_hours</span></a>
<a class="sourceLine" id="cb6-47" data-line-number="47"><span class="st">  FROM </span></a>
<a class="sourceLine" id="cb6-48" data-line-number="48"><span class="st">    world-fishing-827.gfw_research.pipe_v20201001_fishing</span></a>
<a class="sourceLine" id="cb6-49" data-line-number="49"><span class="st">  WHERE </span></a>
<a class="sourceLine" id="cb6-50" data-line-number="50"><span class="st">    _PARTITIONTIME = &#39;2019-01-01&#39;</span></a>
<a class="sourceLine" id="cb6-51" data-line-number="51"><span class="st">  AND seg_id IN (</span></a>
<a class="sourceLine" id="cb6-52" data-line-number="52"><span class="st">    SELECT </span></a>
<a class="sourceLine" id="cb6-53" data-line-number="53"><span class="st">      seg_id</span></a>
<a class="sourceLine" id="cb6-54" data-line-number="54"><span class="st">    FROM </span></a>
<a class="sourceLine" id="cb6-55" data-line-number="55"><span class="st">      good_segments)</span></a>
<a class="sourceLine" id="cb6-56" data-line-number="56"><span class="st">  AND ssvid IN (</span></a>
<a class="sourceLine" id="cb6-57" data-line-number="57"><span class="st">    SELECT</span></a>
<a class="sourceLine" id="cb6-58" data-line-number="58"><span class="st">      ssvid</span></a>
<a class="sourceLine" id="cb6-59" data-line-number="59"><span class="st">    FROM</span></a>
<a class="sourceLine" id="cb6-60" data-line-number="60"><span class="st">      fishing_vessels))</span></a>
<a class="sourceLine" id="cb6-61" data-line-number="61"><span class="st">      </span></a>
<a class="sourceLine" id="cb6-62" data-line-number="62"><span class="st">  ###############################</span></a>
<a class="sourceLine" id="cb6-63" data-line-number="63"><span class="st">  </span></a>
<a class="sourceLine" id="cb6-64" data-line-number="64"><span class="st">  SELECT * FROM fishing_hours&quot;</span></a></code></pre></div>
<p>While there are other techniques for subsetting such as using a list of ssvids, specifying flags, or restricting to a certain gear type, these will not reduce the size and cost of the query. Only filtering based on a partitioned column will affect the size of the query. Generally, partitioned tables are noted in BigQuery with a message under the ‘Details’ tab and more information about how the table is partitioned is available in the Table Info.</p>
<p><img src="images/partitioned_annotated.png" style="width:50.0%;height:50.0%" /></p>
</div>
<div id="saving-downloading-bigquery-tables" class="section level3">
<h3><span class="header-section-number">4.2.5</span> Saving / Downloading BigQuery Tables</h3>
<p>In some cases you might want to save your query results directly to BigQuery. For example, it may be easier to store large tables in BigQuery than trying to work with large amounts of data in R. A large table can then be further queried and subsetted before working with the data in R. Additionally, it may be useful to store tables in BigQuery if you plan to join them with other data stored in BigQuery. For instance, a table of spatial boundaries may be useful to store on BigQuery for spatially filtering data from other BigQuery tables to a specific region of interest. Tables can be saved to BigQuery using either <code>bigrquery::bq_project_query()</code> or <code>DBI::dbWriteTable()</code>. Using the <code>bq_project_query()</code> function allows you to execute the query and save the results as a new table in BigQuery in a single step by adding the <code>destination_table</code> argument. When using DBI you need to execute the query first and then write the results to the database.</p>
<p>Datasets and tables should only be created in the <code>emlab-gcp</code> project. Datasets need to be created before tables can be saved there and can be created in the BigQuery console or in R using <code>bq_dataset_create()</code>. In the BigQuery console datasets can be created by navigating to the <code>emlab-gcp</code> project and selecting the ‘Create Dataset’ button. The default settings for creating the dataset are fine to keep, only the dataset name needs to be added. Once the dataset is created, refreshing the window should show the new dataset on the left hand side nested under the <code>emlab-gcp</code> project.</p>
<p><img src="images/create_dataset_annotated.png" style="width:50.0%;height:50.0%" /></p>
<p>Best practices for naming datasets is to use the official project name, the same one used for the GitHub respository, Google Drive, and other project materials. For tables, names should be descriptive and meaningful. It is advised to follow them emLab SOP guidance in <a href="https://emlab-ucsb.github.io/SOP/3-1-data-file-naming.html">Section 3.1</a> for file naming, specifically using only lower case letters, using ’_’ to separate words, and avoiding ‘-’, ‘.’ and other special characters.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">bq_project_query</span>(<span class="st">&quot;emlab-gcp&quot;</span>,</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">                 sql_fishing_hours,</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">                 <span class="dt">destination_table =</span> <span class="kw">bq_table</span>(<span class="dt">project =</span> <span class="st">&quot;emlab-gcp&quot;</span>,</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">                                              <span class="dt">table =</span> <span class="st">&quot;fishing_hours_20190101&quot;</span>,</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">                                              <span class="dt">dataset =</span> <span class="st">&quot;project_name&quot;</span>),</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">                 <span class="dt">use_legacy_sql =</span> <span class="ot">FALSE</span>, <span class="dt">allowLargeResults =</span> <span class="ot">TRUE</span>)<span class="er">)</span></a></code></pre></div>
<p>These tables now live in BigQuery. If you return to the BigQuery console and refresh it, you should see the table nested under <code>emlab-gcp</code> and the dataset name.</p>
<p><img src="images/add_tables_annotated.png" style="width:50.0%;height:50.0%" /></p>
<p>These tables can now be called directly in future queries and can be downloaded in R at any time using either <code>bigrquery::bq_table_download()</code> or <code>DBI::dbReadTable()</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co"># Download table using bigrquery</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">fishing_hours &lt;-<span class="st"> </span><span class="kw">bq_table_download</span>(<span class="st">&quot;emlab-gcp.project_name.fishing_hours_20190101&quot;</span>,</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">                                   <span class="dt">max_results =</span> <span class="ot">Inf</span>)</a>
<a class="sourceLine" id="cb8-4" data-line-number="4"></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="co"># Download table using DBI </span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="co"># Establish a connection to the emlab-gcp project where your table is saved</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7">bq_connection &lt;-<span class="st"> </span><span class="kw">dbConnect</span>(</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">    <span class="kw">bigquery</span>(),</a>
<a class="sourceLine" id="cb8-9" data-line-number="9">    <span class="dt">project =</span> <span class="st">&quot;emlab-gcp&quot;</span>,</a>
<a class="sourceLine" id="cb8-10" data-line-number="10">    <span class="dt">billing =</span> <span class="st">&quot;emlab-gcp&quot;</span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11">)</a>
<a class="sourceLine" id="cb8-12" data-line-number="12"></a>
<a class="sourceLine" id="cb8-13" data-line-number="13">fishing_hours_dbi &lt;-<span class="st"> </span><span class="kw">dbReadTable</span>(bq_connection,</a>
<a class="sourceLine" id="cb8-14" data-line-number="14">                                 <span class="st">&quot;emlab-gcp.project_name.fishing_hours_20190101&quot;</span>)</a></code></pre></div>
<p>It is important to remember to save any data at the end of the R session to avoid having to re-run queries every time you open the project.</p>

</div>
</div>
<!-- </div> -->
            </section>

          </div>
        </div>
      </div>
<a href="4-1-validation-with-bigquery.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="5-additional-resources.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="assets/gitbook-2.6.7/js/app.min.js"></script>
<script src="assets/gitbook-2.6.7/js/lunr.js"></script>
<script src="assets/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="assets/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": null,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toolbar": {
"position": "static"
},
"search": true
});
});
</script>

</body>

</html>
