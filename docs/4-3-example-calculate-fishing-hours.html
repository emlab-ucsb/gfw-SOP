<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4.3 Example: Calculate Fishing Hours | Global Fishing Watch Data Standard Operating Procedure</title>
  <meta name="description" content="Standard operating procedures for emLab projects using Global Fishing Watch data" />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="4.3 Example: Calculate Fishing Hours | Global Fishing Watch Data Standard Operating Procedure" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://emlab-ucsb.github.io/gfw-SOP/" />
  
  <meta property="og:description" content="Standard operating procedures for emLab projects using Global Fishing Watch data" />
  <meta name="github-repo" content="emlab-ucsb/gfw-SOP" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4.3 Example: Calculate Fishing Hours | Global Fishing Watch Data Standard Operating Procedure" />
  
  <meta name="twitter:description" content="Standard operating procedures for emLab projects using Global Fishing Watch data" />
  

<meta name="author" content="" />


<meta name="date" content="2021-08-23" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="favicon.png" type="image/x-icon" />
<link rel="prev" href="4-2-using-bigquery-in-r.html"/>
<link rel="next" href="5-additional-resources.html"/>
<script src="assets/jquery-2.2.3/jquery.min.js"></script>
<link href="assets/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Overview</a></li>
<li class="chapter" data-level="1" data-path="1-global-fishing-watch-basics.html"><a href="1-global-fishing-watch-basics.html"><i class="fa fa-check"></i><b>1</b> Global Fishing Watch Basics</a><ul>
<li class="chapter" data-level="1.1" data-path="1-1-types-of-data.html"><a href="1-1-types-of-data.html"><i class="fa fa-check"></i><b>1.1</b> Types of Data</a></li>
<li class="chapter" data-level="1.2" data-path="1-2-available-data.html"><a href="1-2-available-data.html"><i class="fa fa-check"></i><b>1.2</b> Available Data</a></li>
<li class="chapter" data-level="1.3" data-path="1-3-data-caution.html"><a href="1-3-data-caution.html"><i class="fa fa-check"></i><b>1.3</b> Data Caution</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="2-setup-and-access.html"><a href="2-setup-and-access.html"><i class="fa fa-check"></i><b>2</b> Setup and Access</a><ul>
<li class="chapter" data-level="2.1" data-path="2-1-bigquery-setup.html"><a href="2-1-bigquery-setup.html"><i class="fa fa-check"></i><b>2.1</b> BigQuery Setup</a></li>
<li class="chapter" data-level="2.2" data-path="2-2-billing.html"><a href="2-2-billing.html"><i class="fa fa-check"></i><b>2.2</b> Billing</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="3-data.html"><a href="3-data.html"><i class="fa fa-check"></i><b>3</b> Data</a><ul>
<li class="chapter" data-level="3.1" data-path="3-1-core-ais-datasets-and-assumptions.html"><a href="3-1-core-ais-datasets-and-assumptions.html"><i class="fa fa-check"></i><b>3.1</b> Core AIS Datasets and Assumptions</a></li>
<li class="chapter" data-level="3.2" data-path="3-2-best-tables.html"><a href="3-2-best-tables.html"><i class="fa fa-check"></i><b>3.2</b> Best Tables</a></li>
<li class="chapter" data-level="3.3" data-path="3-3-vms-datasets.html"><a href="3-3-vms-datasets.html"><i class="fa fa-check"></i><b>3.3</b> VMS Datasets</a></li>
<li class="chapter" data-level="3.4" data-path="3-4-sarviirs-datasets.html"><a href="3-4-sarviirs-datasets.html"><i class="fa fa-check"></i><b>3.4</b> SAR/VIIRS Datasets</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="4-workflow.html"><a href="4-workflow.html"><i class="fa fa-check"></i><b>4</b> Workflow</a><ul>
<li class="chapter" data-level="4.1" data-path="4-1-validation-with-bigquery.html"><a href="4-1-validation-with-bigquery.html"><i class="fa fa-check"></i><b>4.1</b> Validation with BigQuery</a></li>
<li class="chapter" data-level="4.2" data-path="4-2-using-bigquery-in-r.html"><a href="4-2-using-bigquery-in-r.html"><i class="fa fa-check"></i><b>4.2</b> Using BigQuery in R</a><ul>
<li class="chapter" data-level="4.2.1" data-path="4-2-using-bigquery-in-r.html"><a href="4-2-using-bigquery-in-r.html#authorization"><i class="fa fa-check"></i><b>4.2.1</b> Authorization</a></li>
<li class="chapter" data-level="4.2.2" data-path="4-2-using-bigquery-in-r.html"><a href="4-2-using-bigquery-in-r.html#accessing-data"><i class="fa fa-check"></i><b>4.2.2</b> Accessing Data</a></li>
<li class="chapter" data-level="4.2.3" data-path="4-2-using-bigquery-in-r.html"><a href="4-2-using-bigquery-in-r.html#writing-and-executing-queries"><i class="fa fa-check"></i><b>4.2.3</b> Writing and Executing Queries</a></li>
<li class="chapter" data-level="4.2.4" data-path="4-2-using-bigquery-in-r.html"><a href="4-2-using-bigquery-in-r.html#subsetting-data"><i class="fa fa-check"></i><b>4.2.4</b> Subsetting Data</a></li>
<li class="chapter" data-level="4.2.5" data-path="4-2-using-bigquery-in-r.html"><a href="4-2-using-bigquery-in-r.html#saving-downloading-bigquery-tables"><i class="fa fa-check"></i><b>4.2.5</b> Saving / Downloading BigQuery Tables</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="4-3-example-calculate-fishing-hours.html"><a href="4-3-example-calculate-fishing-hours.html"><i class="fa fa-check"></i><b>4.3</b> Example: Calculate Fishing Hours</a><ul>
<li class="chapter" data-level="4.3.1" data-path="4-3-example-calculate-fishing-hours.html"><a href="4-3-example-calculate-fishing-hours.html#setup"><i class="fa fa-check"></i><b>4.3.1</b> Setup</a></li>
<li class="chapter" data-level="4.3.2" data-path="4-3-example-calculate-fishing-hours.html"><a href="4-3-example-calculate-fishing-hours.html#query-data"><i class="fa fa-check"></i><b>4.3.2</b> Query Data</a></li>
<li class="chapter" data-level="4.3.3" data-path="4-3-example-calculate-fishing-hours.html"><a href="4-3-example-calculate-fishing-hours.html#map-fishing-effort"><i class="fa fa-check"></i><b>4.3.3</b> Map Fishing Effort</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="5-additional-resources.html"><a href="5-additional-resources.html"><i class="fa fa-check"></i><b>5</b> Additional Resources</a><ul>
<li class="chapter" data-level="5.1" data-path="5-1-global-fishing-watch-data-training.html"><a href="5-1-global-fishing-watch-data-training.html"><i class="fa fa-check"></i><b>5.1</b> Global Fishing Watch Data Training</a></li>
<li class="chapter" data-level="5.2" data-path="5-2-fishwatchr.html"><a href="5-2-fishwatchr.html"><i class="fa fa-check"></i><b>5.2</b> Fishwatchr</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Global Fishing Watch Data Standard Operating Procedure</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="example-calculate-fishing-hours" class="section level2">
<h2><span class="header-section-number">4.3</span> Example: Calculate Fishing Hours</h2>
<p>In this example we’ll query fishing hours for January 2020 for all active drifting longline fishing vessels. We’ll write the query as a string in R, download the results, and create a map of fishing hours. The example is broken down into three sections: 1) Setup, 2) Query data and 3) Map Fishing Effort.</p>
<div id="setup" class="section level3">
<h3><span class="header-section-number">4.3.1</span> Setup</h3>
<p>Load packages and setup the BigQuery connection. In this example, we’re using <code>bigrquery</code>, a package designed to interface with BigQuery in R. To authorize, we simply call the <code>bq_auth()</code> command it should open a window that allows you to authenticate yourself. If you have already authorized your Google account in R, the authorization should pull up a message allowing you to select a pre-authorized account. Your credentials should typically be your UCSB email address and password.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="kw">library</span>(bigrquery)</a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="kw">library</span>(DBI) </a>
<a class="sourceLine" id="cb9-5" data-line-number="5"></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co"># Authorize the connection</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="kw">bq_auth</span>()</a></code></pre></div>
</div>
<div id="query-data" class="section level3">
<h3><span class="header-section-number">4.3.2</span> Query Data</h3>
<p>Write the query to get fishing hours for all drifting longliners in January 2020 binned at 0.1 degrees. While the query below can be written into a larger nested query, it’s recommended to use subqueries, particularly when starting out in SQL since they are easier to check and debug. Since we are using tables from both the <code>world-fishing-827</code> project and the <code>emlab-gcp</code> project, it’s really important to identify the project when calling the datasets in our query (i.e. starting with <code>world-fishing-827.</code> or <code>emlab-gcp.</code>). The query to calculate fishing hours is composed of several subqueries:</p>
<ol style="list-style-type: decimal">
<li><p>Identify segments to use in the analysis that pass the recommended noise filters (a good segment with more than 10 positions per segment that is not overlapping and short). We’ll be using the testing table, <code>emlab-gcp.emlab_test.pipe_v20201001_subset2020</code></p></li>
<li><p>Create a list of vessels of interest. In this case we will use vessels with a best vessel class of <code>drifting_longlines</code> in 2020 that are on GFW’s best fishing vessel table (<code>world-fishing-827.fishing_vessels_ssvid_v20210706</code>).</p></li>
<li><p>Gather AIS positions for January 2020 only including good segments. We’ll be using the testing table, <code>emlab-gcp.emlab_test.pipe_v20201001_fishing_subset2020</code>.</p></li>
<li><p>Filter AIS positions for our vessels of interest</p></li>
<li><p>Calculate fishing hours. Fishing hours are calculated using <code>hours</code> and the <code>nnet_score</code>. When the <code>nnet_score = 1</code> the neural net thinks this is a fishing position so we assign the <code>hours</code> as fishing hours.</p></li>
<li><p>Aggregate fishing hours. We’ll bin fishing hours at 0.1 degree resolution and aggregate across grids. This gives us a total estimate of fishing hours for each cell by all drifting longline vessels in January 2020. Note: by including the <code>ssvid</code> and/or <code>date</code> in the <code>GROUP BY</code> statement you can aggregate fishing hours per grid cell by vessel and date.</p></li>
</ol>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">sql_fishing_hours &lt;-<span class="st"> &quot;#StandardSQL</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="st">WITH</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="st">  ##################################</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="st">  # Identify good segments using</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="st">  # GFW&#39;s recommended noise filters</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="st">  </span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="st">  good_segments AS (</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10"><span class="st">  SELECT</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11"><span class="st">    seg_id</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12"><span class="st">  FROM</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="st">    `emlab-gcp.emlab_test.pipe_v20201001_segs_subset2020`  </span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14"><span class="st">  WHERE </span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15"><span class="st">    good_seg</span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16"><span class="st">  AND positions &gt; 10 </span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17"><span class="st">  AND NOT overlapping_and_short </span></a>
<a class="sourceLine" id="cb10-18" data-line-number="18"><span class="st">  ),</span></a>
<a class="sourceLine" id="cb10-19" data-line-number="19"></a>
<a class="sourceLine" id="cb10-20" data-line-number="20"><span class="st">  ##################################</span></a>
<a class="sourceLine" id="cb10-21" data-line-number="21"><span class="st">  # List of drifting longline fishing</span></a>
<a class="sourceLine" id="cb10-22" data-line-number="22"><span class="st">  # vessels in 2020 </span></a>
<a class="sourceLine" id="cb10-23" data-line-number="23"></a>
<a class="sourceLine" id="cb10-24" data-line-number="24"><span class="st">  longline_vessels_2020 AS (</span></a>
<a class="sourceLine" id="cb10-25" data-line-number="25"><span class="st">  SELECT </span></a>
<a class="sourceLine" id="cb10-26" data-line-number="26"><span class="st">    ssvid,</span></a>
<a class="sourceLine" id="cb10-27" data-line-number="27"><span class="st">    year</span></a>
<a class="sourceLine" id="cb10-28" data-line-number="28"><span class="st">  FROM </span></a>
<a class="sourceLine" id="cb10-29" data-line-number="29"><span class="st">    `world-fishing-827.gfw_research.fishing_vessels_ssvid_v20210706`</span></a>
<a class="sourceLine" id="cb10-30" data-line-number="30"><span class="st">  WHERE </span></a>
<a class="sourceLine" id="cb10-31" data-line-number="31"><span class="st">    best_vessel_class = &#39;drifting_longlines&#39;</span></a>
<a class="sourceLine" id="cb10-32" data-line-number="32"><span class="st">    AND year = 2020</span></a>
<a class="sourceLine" id="cb10-33" data-line-number="33"><span class="st">  ),</span></a>
<a class="sourceLine" id="cb10-34" data-line-number="34"></a>
<a class="sourceLine" id="cb10-35" data-line-number="35"><span class="st">  ##################################</span></a>
<a class="sourceLine" id="cb10-36" data-line-number="36"><span class="st">  # Fishing positions for January </span></a>
<a class="sourceLine" id="cb10-37" data-line-number="37"><span class="st">  # 2020 from the emlab test table </span></a>
<a class="sourceLine" id="cb10-38" data-line-number="38"></a>
<a class="sourceLine" id="cb10-39" data-line-number="39"><span class="st">  fishing_positions AS (</span></a>
<a class="sourceLine" id="cb10-40" data-line-number="40"><span class="st">  SELECT </span></a>
<a class="sourceLine" id="cb10-41" data-line-number="41"><span class="st">    ssvid,</span></a>
<a class="sourceLine" id="cb10-42" data-line-number="42"><span class="st">    lat,</span></a>
<a class="sourceLine" id="cb10-43" data-line-number="43"><span class="st">    lon,</span></a>
<a class="sourceLine" id="cb10-44" data-line-number="44"><span class="st">    EXTRACT(date FROM timestamp) AS date,</span></a>
<a class="sourceLine" id="cb10-45" data-line-number="45"><span class="st">    EXTRACT(year FROM timestamp) AS year,</span></a>
<a class="sourceLine" id="cb10-46" data-line-number="46"><span class="st">    hours,</span></a>
<a class="sourceLine" id="cb10-47" data-line-number="47"><span class="st">    nnet_score</span></a>
<a class="sourceLine" id="cb10-48" data-line-number="48"><span class="st">  FROM </span></a>
<a class="sourceLine" id="cb10-49" data-line-number="49"><span class="st">    `emlab-gcp.emlab_test.pipe_v20201001_fishing_jan2020`</span></a>
<a class="sourceLine" id="cb10-50" data-line-number="50"><span class="st">  WHERE </span></a>
<a class="sourceLine" id="cb10-51" data-line-number="51"><span class="st">  # Keep only good segments </span></a>
<a class="sourceLine" id="cb10-52" data-line-number="52"><span class="st">  seg_id IN(</span></a>
<a class="sourceLine" id="cb10-53" data-line-number="53"><span class="st">    SELECT </span></a>
<a class="sourceLine" id="cb10-54" data-line-number="54"><span class="st">      seg_id</span></a>
<a class="sourceLine" id="cb10-55" data-line-number="55"><span class="st">    FROM </span></a>
<a class="sourceLine" id="cb10-56" data-line-number="56"><span class="st">      good_segments</span></a>
<a class="sourceLine" id="cb10-57" data-line-number="57"><span class="st">   )</span></a>
<a class="sourceLine" id="cb10-58" data-line-number="58"><span class="st">  ),</span></a>
<a class="sourceLine" id="cb10-59" data-line-number="59"></a>
<a class="sourceLine" id="cb10-60" data-line-number="60"><span class="st">  ##################################</span></a>
<a class="sourceLine" id="cb10-61" data-line-number="61"><span class="st">  # Filter fishing positions for </span></a>
<a class="sourceLine" id="cb10-62" data-line-number="62"><span class="st">  # only our vessels of interest</span></a>
<a class="sourceLine" id="cb10-63" data-line-number="63"></a>
<a class="sourceLine" id="cb10-64" data-line-number="64"><span class="st">  fishing_filtered AS (</span></a>
<a class="sourceLine" id="cb10-65" data-line-number="65"><span class="st">  SELECT </span></a>
<a class="sourceLine" id="cb10-66" data-line-number="66"><span class="st">    *</span></a>
<a class="sourceLine" id="cb10-67" data-line-number="67"><span class="st">  FROM </span></a>
<a class="sourceLine" id="cb10-68" data-line-number="68"><span class="st">    fishing_positions</span></a>
<a class="sourceLine" id="cb10-69" data-line-number="69"><span class="st">  JOIN longline_vessels_2020</span></a>
<a class="sourceLine" id="cb10-70" data-line-number="70"><span class="st">  # Only keep positions for fishing vessels active that year</span></a>
<a class="sourceLine" id="cb10-71" data-line-number="71"><span class="st">  USING(ssvid, year)</span></a>
<a class="sourceLine" id="cb10-72" data-line-number="72"><span class="st">  ),</span></a>
<a class="sourceLine" id="cb10-73" data-line-number="73"></a>
<a class="sourceLine" id="cb10-74" data-line-number="74"><span class="st">  ##################################</span></a>
<a class="sourceLine" id="cb10-75" data-line-number="75"><span class="st">  # Calculating fishing hours for </span></a>
<a class="sourceLine" id="cb10-76" data-line-number="76"><span class="st">  # each position </span></a>
<a class="sourceLine" id="cb10-77" data-line-number="77"></a>
<a class="sourceLine" id="cb10-78" data-line-number="78"><span class="st">  calc_fishing_hours AS (</span></a>
<a class="sourceLine" id="cb10-79" data-line-number="79"><span class="st">  SELECT </span></a>
<a class="sourceLine" id="cb10-80" data-line-number="80"><span class="st">    *,</span></a>
<a class="sourceLine" id="cb10-81" data-line-number="81"><span class="st">    IF(nnet_score = 1, hours, 0) As fishing_hours</span></a>
<a class="sourceLine" id="cb10-82" data-line-number="82"><span class="st">  FROM </span></a>
<a class="sourceLine" id="cb10-83" data-line-number="83"><span class="st">    fishing_filtered</span></a>
<a class="sourceLine" id="cb10-84" data-line-number="84"><span class="st">  ),</span></a>
<a class="sourceLine" id="cb10-85" data-line-number="85"></a>
<a class="sourceLine" id="cb10-86" data-line-number="86"><span class="st">  ##################################</span></a>
<a class="sourceLine" id="cb10-87" data-line-number="87"><span class="st">  # Aggregate fishing hours by</span></a>
<a class="sourceLine" id="cb10-88" data-line-number="88"><span class="st">  # grid cell </span></a>
<a class="sourceLine" id="cb10-89" data-line-number="89"></a>
<a class="sourceLine" id="cb10-90" data-line-number="90"><span class="st">  fishing_binned AS (</span></a>
<a class="sourceLine" id="cb10-91" data-line-number="91"><span class="st">  SELECT</span></a>
<a class="sourceLine" id="cb10-92" data-line-number="92"><span class="st">    # Convert lat/lon to 0.1 degree bins</span></a>
<a class="sourceLine" id="cb10-93" data-line-number="93"><span class="st">    FLOOR(lat * 10) / 10  AS lat_bin,</span></a>
<a class="sourceLine" id="cb10-94" data-line-number="94"><span class="st">    FLOOR(lon * 10) / 10 AS lon_bin,</span></a>
<a class="sourceLine" id="cb10-95" data-line-number="95"><span class="st">    SUM(hours) as hours,</span></a>
<a class="sourceLine" id="cb10-96" data-line-number="96"><span class="st">    SUM(fishing_hours) as fishing_hours</span></a>
<a class="sourceLine" id="cb10-97" data-line-number="97"><span class="st">  FROM </span></a>
<a class="sourceLine" id="cb10-98" data-line-number="98"><span class="st">    calc_fishing_hours</span></a>
<a class="sourceLine" id="cb10-99" data-line-number="99"><span class="st">  GROUP BY lat_bin, lon_bin</span></a>
<a class="sourceLine" id="cb10-100" data-line-number="100"><span class="st">  )</span></a>
<a class="sourceLine" id="cb10-101" data-line-number="101"></a>
<a class="sourceLine" id="cb10-102" data-line-number="102"><span class="st">  SELECT * FROM fishing_binned&quot;</span></a></code></pre></div>
<p>Run the query and write the results as a table (<code>test_fishing_hours_jan2020_tenthdegree</code>) in BigQuery. This way the query doesn’t have to be re-run every time the SOP gets updated. Instead, we just download the table we created into the working environment. Using the BigQuery console to validate the query it will bill ~12 GB (&lt; $1).</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">bq_project_query</span>(<span class="st">&quot;emlab-gcp&quot;</span>, <span class="co">#Billing project</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">                 sql_fishing_hours, <span class="co">#Query string object</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3">                 <span class="dt">destination_table =</span> <span class="kw">bq_table</span>(<span class="dt">project =</span> <span class="st">&quot;emlab-gcp&quot;</span>,</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">                                              <span class="dt">dataset =</span> <span class="st">&quot;emlab_test&quot;</span>,</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">                                              <span class="dt">table =</span> <span class="st">&quot;test_fishing_hours_jan2020_tenthdegree&quot;</span>),</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">                 <span class="dt">use_legacy_sql =</span> <span class="ot">FALSE</span>,  <span class="co">#False specifies we are using Standard SQL</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7">                 <span class="dt">allowLargeResults =</span> <span class="ot">TRUE</span>) <span class="co">#True to allow for large outputs</span></a></code></pre></div>
</div>
<div id="map-fishing-effort" class="section level3">
<h3><span class="header-section-number">4.3.3</span> Map Fishing Effort</h3>
<p>We’ll use the data from the table we just created to make a global map of fishing effort in January 2020 for all drifting longline vessels. Fishing hours range from just above 0 to just over 500 although most fishing hours values are below 100. Fishing hours can be displayed in a number of ways including total fishing hours, total fishing hours per area (<span class="math inline">\(km^2\)</span>) or log transformed fishing hours. In this example, we’ll log transform the fishing hours. The colors used to produce the base map were taken from GFW color palletes which are part of the <code>fishwatchr</code> package. More inforamtion on installing and using the <code>fishwatchr</code> package can be found in the package <a href="https://github.com/GlobalFishingWatch/fishwatchr#fishwatchr">repository</a>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co"># Download a global map</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2">land_sf &lt;-<span class="st"> </span>rnaturalearth<span class="op">::</span><span class="kw">ne_countries</span>(<span class="dt">scale =</span> <span class="dv">50</span>, <span class="dt">returnclass =</span> <span class="st">&quot;sf&quot;</span>)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3"></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="co"># Download the fishing hours data</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5">fishing_hours &lt;-<span class="st"> </span><span class="kw">bq_table_download</span>(<span class="st">&quot;emlab-gcp.emlab_test.test_fishing_hours_jan2020_tenthdegree&quot;</span>,</a>
<a class="sourceLine" id="cb12-6" data-line-number="6">                                   <span class="dt">n_max =</span> <span class="ot">Inf</span>)</a>
<a class="sourceLine" id="cb12-7" data-line-number="7"></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="co"># Graph only non-zero fishing hours </span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9">nonzero_hours &lt;-<span class="st"> </span>fishing_hours <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(fishing_hours <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb12-11" data-line-number="11"></a>
<a class="sourceLine" id="cb12-12" data-line-number="12"></a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="co"># Map fishing hours </span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14">fishing_map &lt;-<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> land_sf, </a>
<a class="sourceLine" id="cb12-16" data-line-number="16">          <span class="dt">color =</span> <span class="st">&quot;#0A1738&quot;</span>, </a>
<a class="sourceLine" id="cb12-17" data-line-number="17">          <span class="dt">fill =</span> <span class="st">&quot;#374a6d&quot;</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="st">  </span><span class="kw">geom_tile</span>(<span class="dt">data =</span> nonzero_hours, </a>
<a class="sourceLine" id="cb12-19" data-line-number="19">            <span class="kw">aes</span>(<span class="dt">x =</span> lon_bin, <span class="dt">y =</span> lat_bin, <span class="dt">fill =</span> fishing_hours)) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-20" data-line-number="20"><span class="st">  </span>viridis<span class="op">::</span><span class="kw">scale_fill_viridis</span>(<span class="dt">name =</span> <span class="st">&quot;Log(Fishing Hours)&quot;</span>, <span class="dt">begin =</span> <span class="dv">1</span>, <span class="dt">end =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb12-21" data-line-number="21">                              <span class="dt">trans =</span> <span class="st">&quot;log&quot;</span>,</a>
<a class="sourceLine" id="cb12-22" data-line-number="22">                              <span class="dt">breaks =</span> scales<span class="op">::</span><span class="kw">log_breaks</span>(<span class="dt">n =</span> <span class="dv">6</span>, <span class="dt">base =</span> <span class="dv">10</span>),</a>
<a class="sourceLine" id="cb12-23" data-line-number="23">                              <span class="dt">labels =</span> scales<span class="op">::</span><span class="kw">label_number</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-24" data-line-number="24"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Drifting Longline Fishing Hours&quot;</span>,</a>
<a class="sourceLine" id="cb12-25" data-line-number="25">       <span class="dt">subtitle =</span> <span class="st">&quot;January 2020&quot;</span>,</a>
<a class="sourceLine" id="cb12-26" data-line-number="26">       <span class="dt">y =</span> <span class="st">&quot;&quot;</span>,</a>
<a class="sourceLine" id="cb12-27" data-line-number="27">       <span class="dt">x =</span> <span class="st">&quot;&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-28" data-line-number="28"><span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-29" data-line-number="29"><span class="st">  </span><span class="co"># Styling </span></a>
<a class="sourceLine" id="cb12-30" data-line-number="30"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.border =</span> <span class="kw">element_blank</span>(), </a>
<a class="sourceLine" id="cb12-31" data-line-number="31">        <span class="dt">panel.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> <span class="st">&quot;#0a1738&quot;</span>, <span class="dt">color =</span> <span class="ot">NA</span>), </a>
<a class="sourceLine" id="cb12-32" data-line-number="32">        <span class="dt">panel.grid.major =</span> <span class="kw">element_line</span>(<span class="dt">color =</span> <span class="st">&quot;#0a1738&quot;</span>), </a>
<a class="sourceLine" id="cb12-33" data-line-number="33">        <span class="dt">panel.grid.minor =</span> <span class="kw">element_line</span>(<span class="dt">color =</span> <span class="st">&quot;#0a1738&quot;</span>),</a>
<a class="sourceLine" id="cb12-34" data-line-number="34">        <span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>, </a>
<a class="sourceLine" id="cb12-35" data-line-number="35">        <span class="dt">legend.box =</span> <span class="st">&quot;vertical&quot;</span>, </a>
<a class="sourceLine" id="cb12-36" data-line-number="36">        <span class="dt">legend.key.height =</span> <span class="kw">unit</span>(<span class="dv">3</span>, <span class="st">&quot;mm&quot;</span>), </a>
<a class="sourceLine" id="cb12-37" data-line-number="37">        <span class="dt">legend.key.width =</span> <span class="kw">unit</span>(<span class="dv">20</span>, <span class="st">&quot;mm&quot;</span>),</a>
<a class="sourceLine" id="cb12-38" data-line-number="38">        <span class="dt">legend.title.align =</span> <span class="fl">0.5</span>,</a>
<a class="sourceLine" id="cb12-39" data-line-number="39">        <span class="dt">legend.text =</span> <span class="kw">element_text</span>(<span class="dt">color =</span> <span class="st">&quot;#848b9b&quot;</span>, <span class="dt">size =</span> <span class="dv">10</span>), </a>
<a class="sourceLine" id="cb12-40" data-line-number="40">        <span class="dt">legend.title =</span> <span class="kw">element_text</span>(<span class="dt">color =</span> <span class="st">&quot;#363c4c&quot;</span>, <span class="dt">size =</span> <span class="dv">10</span>), </a>
<a class="sourceLine" id="cb12-41" data-line-number="41">        <span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">color =</span> <span class="st">&quot;#363c4c&quot;</span>, <span class="dt">size =</span> <span class="dv">12</span>), </a>
<a class="sourceLine" id="cb12-42" data-line-number="42">        <span class="dt">plot.subtitle =</span> <span class="kw">element_text</span>(<span class="dt">color =</span> <span class="st">&quot;#363c4c&quot;</span>, <span class="dt">size =</span> <span class="dv">12</span>), </a>
<a class="sourceLine" id="cb12-43" data-line-number="43">        <span class="dt">axis.title =</span> <span class="kw">element_blank</span>(), </a>
<a class="sourceLine" id="cb12-44" data-line-number="44">        <span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">6</span>)) </a></code></pre></div>
<p><br></p>
<p><img src="images/fishing_hours_map.png" /></p>

</div>
</div>
<!-- </div> -->
            </section>

          </div>
        </div>
      </div>
<a href="4-2-using-bigquery-in-r.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="5-additional-resources.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="assets/gitbook-2.6.7/js/app.min.js"></script>
<script src="assets/gitbook-2.6.7/js/lunr.js"></script>
<script src="assets/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="assets/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": null,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toolbar": {
"position": "static"
},
"search": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
